#make file for testing and evaluate coverage for libmerc with libmerc_driver

include ../Makefile_helper.mk

export LD_LIBRARY_PATH =../src/libmerc

LIBMERC_FOLDER = ../src/libmerc/
LIBMERC_SO = $(LIBMERC_FOLDER)libmerc.so
LIBMERC_SO_tls = $(LIBMERC_FOLDER)libmerc_tls.so
LIBMERC_SO_multiprotocol = $(LIBMERC_FOLDER)libmerc_multiprotocol.so
UNIT_TESTS = catch2main.cc
UNIT_TESTS += ../src/pcap_file_io.c
UNIT_TESTS += libmerc_driver_helper.cc
UNIT_TESTS += libmerc_fixture.cc

UNIT_TESTS_H = catch.hpp
UNIT_TESTS_H += libmerc_driver_helper.hpp
UNIT_TESTS_H += libmerc_api.hpp
UNIT_TESTS_H += libmerc_fixture.h

UNIT_TESTS_TLS_ONLY = $(UNIT_TESTS)
UNIT_TESTS_TLS_ONLY += general_info_test.cc
#UNIT_TESTS_TLS_ONLY += libmerc_flow_test.cc
UNIT_TESTS_TLS_ONLY += libmerc_tlsdb_test.cc
UNIT_TESTS_TLS_ONLY += libmerc_driver.cc

UNIT_TESTS_TLS_HTTP_QUIC = $(UNIT_TESTS)
UNIT_TESTS_TLS_HTTP_QUIC += libmerc_dbmultiprotocol_test.cc

# implicit rules for building object files from .cc files
%.o: %.cc
	$(CXX) $(CFLAGS) -c $<

# target to build all executables
#
all: libmerc_driver_tls_only libmerc_driver_multiprotocol pdu_verifier

libmerc_driver_tls_only: debug-libmerc $(UNIT_TESTS_TLS_ONLY) $(LIBMERC_SO) Makefile.in $(UNIT_TESTS_H)
	$(CXX) $(CFLAGS) -I ../src/ -I../src/libmerc $(UNIT_TESTS_TLS_ONLY) -pthread -o libmerc_driver_tls_only -fsanitize=address -lasan -L./libmerc $(LIBMERC_SO) -lcrypto -ldl -lz
	@echo "creating copy of libmerc.so for testing purposes"
	cp $(LIBMERC_SO) $(LIBMERC_SO_tls).alt
	cp $(LIBMERC_SO) $(LIBMERC_SO_tls)
	
libmerc_driver_multiprotocol: CFLAGS += -DSTATIC_CFG_SELECT="\"tls.client_hello,http.request,quic\""
libmerc_driver_multiprotocol: debug-libmerc $(UNIT_TESTS_TLS_HTTP_QUIC) $(LIBMERC_SO) Makefile.in $(UNIT_TESTS_H)
	$(CXX) $(CFLAGS) -I ../src/ -I../src/libmerc $(UNIT_TESTS_TLS_HTTP_QUIC) -pthread -o libmerc_driver_multiprotocol -fsanitize=address -lasan -L./libmerc $(LIBMERC_SO) -lcrypto -ldl -lz
	@echo "creating copy of libmerc.so for testing purposes"
	cp $(LIBMERC_SO) $(LIBMERC_SO_multiprotocol)
	cp $(LIBMERC_SO) $(LIBMERC_SO_multiprotocol).alt

libmerc_driver_coverage: debug-libmerc_gcov $(UNIT_TESTS) $(LIBMERC_SO) Makefile.in $(UNIT_TESTS_H)
	$(CXX) $(CFLAGS) -I ../src/ -I../src/libmerc $(UNIT_TESTS) -pthread -o libmerc_driver -fsanitize=address -lasan -L./libmerc $(LIBMERC_SO) -lcrypto -ldl -lz --coverage
	@echo "creating copy of libmerc.so for testing purposes"
	cp $(LIBMERC_SO) $(LIBMERC_SO).alt

pdu_verifier: pdu_verifier.cc
	$(CXX) $(CFLAGS) -I ../src/ -I ../src/libmerc pdu_verifier.cc ./../src/pcap_file_io.c -lasan -L./libmerc $(LIBMERC_SO) -lcrypto -ldl -lz -o pdu_verifier

.PHONY: debug-libmerc_gcov
debug-libmerc_gcov: 
	cd ../src && $(MAKE) debug-libmerc_gcov

.PHONY: debug-libmerc
debug-libmerc:
	cd ../src && $(MAKE) debug-libmerc

.PHONY: clean
clean:
	rm -rf libmerc_driver_multiprotocol
	rm -rf libmerc_driver_tls_only
	rm -rf pdu_verifier
	rm -rf *.json.gz
	find -type f -name "*.gcno" -delete
	find -type f -name "*.gcda" -delete
	find -type f -name "*.gcov" -delete
	cd ../src; $(MAKE) clean

# EOF
